<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานกิจกรรม 12 เดือน (ส่วนกลาง)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body { font-family: 'Inter', 'Kanit', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .day-cell.today { background-color: #fce7f3; color: #db2777; font-weight: bold; }
        .day-cell.selected { background-color: #3b82f6 !important; color: white !important; }
        .dot-container { position: absolute; bottom: 2px; left: 0; right: 0; display: flex; justify-content: center; align-items: center; gap: 1px; padding: 0 4px; flex-wrap: wrap; }
        .dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
        .report-activity-card { border-left-width: 8px; }
        input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 2.5rem; height: 2.5rem; padding: 0; border: none; border-radius: 50px; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 0.375rem; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="max-w-5xl mx-auto p-4 sm:p-6">
        
        <header class="bg-white p-6 rounded-lg shadow-xl mb-8 ">
            <div class="flex justify-between items-center mb-6">
                <button id="prev-year-btn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h1 class="text-xl sm:text-3xl font-bold text-gray-800 text-center">
                    รายงานกิจกรรมประจำปี (ต.ค. - ก.ย.)
                </h1>
                <button id="next-year-btn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <h2 id="year-subtitle-header" class="text-center text-lg sm:text-xl text-rose-500 font-semibold -mt-4 mb-4">
                ตุลาคม 2024 - กันยายน 2025
            </h2>
            
            <div class="space-y-6 border-t pt-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">1. เพิ่มกิจกรรมใหม่</h3>
                        <form id="activity-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="col-span-1">
                                <label for="activity-date" class="block text-sm font-medium text-gray-700">วันที่</label>
                                <input type="date" id="activity-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                            </div>
                            <div class="col-span-1">
                                <label for="activity-category" class="block text-sm font-medium text-gray-700">ประเภท</label>
                                <select id="activity-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required></select>
                            </div>
                            <div class="col-span-full">
                                <label for="activity-desc" class="block text-sm font-medium text-gray-700">กิจกรรม</label>
                                <input type="text" id="activity-desc" placeholder="เช่น: ประชุมกับลูกค้า" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                            </div>
                            <div class="col-span-full">
                                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-zinc-700 hover:bg-zinc-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-zinc-500">
                                    บันทึกกิจกรรม
                                </button>
                            </div>
                        </form>
                    </div>

                    <div id="category-management-box" class="md:border-t-0 md:pt-0">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">2. จัดการประเภทกิจกรรม</h3>
                        <div id="category-list" class="space-y-2 mb-4 p-2 rounded-md border border-gray-200">
                            <p id="no-category-msg" class="text-gray-500 text-center">ยังไม่มีประเภท</p>
                        </div>
                        <form id="category-form" class="flex gap-2 items-center">
                            <input type="text" id="category-name" placeholder="ชื่อประเภทใหม่" class="flex-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" required>
                            <input type="color" id="category-color" value="#3b82f6">
                            <button type="submit" class="p-2 rounded-md text-white bg-zinc-700 hover:bg-zinc-900">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            </button>
                        </form>
                    </div>

                </div>
            </div>
        </header>

        <main id="report-container" class="space-y-8">
            <p id="loading-msg" class="text-center text-gray-500">กำลังโหลดข้อมูล...</p>
        </main>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBxgoNJobE20jv6HrfGhVxMzS85ARsudg0",
            authDomain: "labevent-49643.firebaseapp.com",
            projectId: "labevent-49643",
            storageBucket: "labevent-49643.firebasestorage.app",
            messagingSenderId: "894959859014",
            appId: "1:894959859014:web:b46866f5f9fbc2aa302147",
            measurementId: "G-7XQ8H3N64B"
        };
        
        const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
        const thaiDaysShort = ["อา", "จ", "อ", "พ", "พฤ", "ศ", "ส"];
        const todayString = new Date().toISOString().split('T')[0];

        let app, db;
        let activitiesCollectionRef, categoriesCollectionRef;
        let isReady = false; 

        let currentStartYear;
        let allCategories = new Map();
        let allActivities = [];

        const yearSubtitleHeader = document.getElementById('year-subtitle-header');
        const prevYearBtn = document.getElementById('prev-year-btn');
        const nextYearBtn = document.getElementById('next-year-btn');
        const reportContainer = document.getElementById('report-container');
        const loadingMsg = document.getElementById('loading-msg');
        const categoryList = document.getElementById('category-list');
        const noCategoryMsg = document.getElementById('no-category-msg');
        const categoryForm = document.getElementById('category-form');
        const categoryNameInput = document.getElementById('category-name');
        const categoryColorInput = document.getElementById('category-color');
        const activityForm = document.getElementById('activity-form');
        const activityDateInput = document.getElementById('activity-date');
        const activityCategorySelect = document.getElementById('activity-category');
        const activityDescInput = document.getElementById('activity-desc');
        
        function formatThaiDate(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('-');
            const day = parseInt(parts[2], 10);
            const year = parseInt(parts[0], 10);
            const monthIndex = parseInt(parts[1], 10) - 1;
            return `${day} ${thaiMonths[monthIndex]} ${year + 543}`;
        }
        
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // *** แก้ไข Path ให้มีจำนวนส่วนเป็นเลขคี่ (5 ส่วน) ***
                // รูปแบบ: collection/document/collection/document/collection
                const activitiesPath = `artifacts/labevent-v1/shared-data/main/monthly_activities`;
                const categoriesPath = `artifacts/labevent-v1/shared-data/main/activity_categories`;
                
                activitiesCollectionRef = collection(db, activitiesPath);
                categoriesCollectionRef = collection(db, categoriesPath);

                isReady = true;
                console.log("App is ready. Using shared data collections.");
                setupApp();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                reportContainer.innerHTML = "<p class='text-red-500 col-span-full'>เกิดข้อผิดพลาดในการเริ่มต้น Firebase: " + error.message + "</p>";
            }
        }
        
        function setupApp() {
            if (!isReady) return;
            const today = new Date();
            currentStartYear = (today.getMonth() < 9) ? today.getFullYear() - 1 : today.getFullYear();
            activityDateInput.value = todayString;
            setupListeners();
            listenForCategories(); 
            listenForActivities(); 
        }

        function updateView() {
            loadingMsg.classList.add('hidden');
            const startYear = currentStartYear;
            const endYear = startYear + 1;
            yearSubtitleHeader.textContent = `ตุลาคม ${startYear} - กันยายน ${endYear}`;
            reportContainer.innerHTML = '';

            const monthsToDisplay = [];
            for (let m = 9; m <= 11; m++) monthsToDisplay.push({ month: m, year: startYear });
            for (let m = 0; m <= 8; m++) monthsToDisplay.push({ month: m, year: endYear });

            const activitiesByMonth = new Map();
            for (const act of allActivities) {
                const monthYearKey = act.date.substring(0, 7);
                if (!activitiesByMonth.has(monthYearKey)) activitiesByMonth.set(monthYearKey, []);
                activitiesByMonth.get(monthYearKey).push(act);
            }

            monthsToDisplay.forEach(monthObj => {
                const monthIndex = monthObj.month;
                const year = monthObj.year;
                const monthYearKey = `${year}-${String(monthIndex + 1).padStart(2, '0')}`;
                
                const activities = activitiesByMonth.get(monthYearKey) || [];
                activities.sort((a, b) => a.date.localeCompare(b.date));
                
                const calendarHTML = createMonthCalendarHTML(monthIndex, year);
                const activityHTML = createMonthActivityListHTML(activities);
                
                const monthBlock = document.createElement('div');
                monthBlock.className = 'month-report-block bg-white shadow-lg rounded-xl p-4 sm:p-6';
                
                monthBlock.innerHTML = `
                    <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 text-zinc-500">${thaiMonths[monthIndex]} ${year + 543}</h3>
                    <div class="flex flex-col lg:flex-row gap-6">
                        <div class="w-full lg:w-2/5">${calendarHTML}</div>
                        <div class="w-full lg:w-3/5">${activityHTML}</div>
                    </div>
                `;
                reportContainer.appendChild(monthBlock);
            });
            
            const selectedDate = activityDateInput.value;
            if (selectedDate) {
                 const cell = reportContainer.querySelector(`.day-cell[data-date="${selectedDate}"]`);
                 if (cell) cell.classList.add('selected');
            }
            setTimeout(updateActivityDots, 0);
        }

        function createMonthCalendarHTML(monthIndex, year) {
            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
            const firstDayOfWeek = new Date(year, monthIndex, 1).getDay();
            let html = `<div class="p-2 sm:p-4 rounded-lg bg-white border h-full">`;
            html += `<div class="grid grid-cols-7 text-center text-xs font-semibold text-gray-500 mb-2">`;
            thaiDaysShort.forEach(day => { html += `<div class="w-8 h-8 flex items-center justify-center">${day}</div>`; });
            html += `</div><div class="grid grid-cols-7 text-center text-sm">`;
            for (let i = 0; i < firstDayOfWeek; i++) html += `<div></div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(monthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let cellClasses = 'day-cell relative w-8 h-8 mx-auto flex items-center justify-center rounded-full cursor-pointer hover:bg-gray-200';
                if (dateStr === todayString) cellClasses += ' today';
                html += `<div class="${cellClasses}" data-date="${dateStr}">${day}<div class="dot-container"></div></div>`;
            }
            html += `</div></div>`;
            return html;
        }

        function createMonthActivityListHTML(activities) {
            if (activities.length === 0) {
                return `<div class="h-full flex items-center justify-center border border-dashed border-gray-300 rounded-lg p-4"><p class="text-gray-500">ยังไม่มีกิจกรรมในเดือนนี้</p></div>`;
            }
            let html = `<div class="space-y-3 max-h-[400px] lg:max-h-full overflow-y-auto custom-scrollbar pr-2">`;
            activities.forEach(act => {
                const category = allCategories.get(act.categoryId);
                const color = category ? category.color : '#9ca3af';
                const categoryName = category ? category.name : 'ไม่มีประเภท';
                const formattedDate = formatThaiDate(act.date);
                const day = parseInt(act.date.substring(8, 10));
                html += `
                    <div class="report-activity-card bg-gray-50 rounded-lg p-3 shadow-sm hover:shadow-md transition-shadow" style="border-color: ${color};">
                        <div class="flex justify-between items-start">
                            <div class="flex items-start gap-3 flex-grow">
                                <span class="text-lg font-extrabold w-6 text-right pt-0.5">${day}</span>
                                <div class="flex-grow">
                                    <p class="text-base font-medium text-gray-900">${act.description}</p>
                                    <p class="text-xs font-medium text-gray-500 -mt-1">${formattedDate}</p>
                                   
                                </div>
                                 <p class="text-xs font-semibold mt-1" style="color: ${color};">${categoryName}</p>
                            </div>
                            <button class="delete-activity-btn text-red-400 hover:text-red-600 p-1 flex-shrink-0 ml-2" data-id="${act.id}">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M6 8a1 1 0 00-1 1v6a1 1 0 102 0V9a1 1 0 00-1-1zM10 8a1 1 0 00-1 1v6a1 1 0 102 0V9a1 1 0 00-1-1zM14 8a1 1 0 00-1 1v6a1 1 0 102 0V9a1 1 0 00-1-1zM4 6h12v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm3 0V4a2 2 0 012-2h2a2 2 0 012 2v2H7z"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            return html;
        }

        function setupListeners() {
            prevYearBtn.addEventListener('click', () => { currentStartYear--; updateView(); });
            nextYearBtn.addEventListener('click', () => { currentStartYear++; updateView(); });
            reportContainer.addEventListener('click', (e) => {
                const dayCell = e.target.closest('.day-cell');
                if (dayCell && dayCell.dataset.date) {
                    activityDateInput.value = dayCell.dataset.date;
                    document.querySelectorAll('.day-cell.selected').forEach(c => c.classList.remove('selected'));
                    dayCell.classList.add('selected');
                }
            });
            activityForm.addEventListener('submit', handleAddActivity);
            categoryForm.addEventListener('submit', handleAddCategory);
            reportContainer.addEventListener('click', (e) => {
                 const deleteBtn = e.target.closest('.delete-activity-btn');
                if (deleteBtn) handleDeleteActivity(deleteBtn.dataset.id);
            });
            categoryList.addEventListener('click', (e) => {
                 const deleteBtn = e.target.closest('.delete-category-btn');
                if (deleteBtn) handleDeleteCategory(deleteBtn.dataset.id);
            });
        }
        
        function listenForCategories() {
            if (!isReady) return;
            onSnapshot(query(categoriesCollectionRef), (snapshot) => {
                allCategories.clear();
                snapshot.docs.forEach(doc => { allCategories.set(doc.id, { id: doc.id, ...doc.data() }); });
                renderCategoryUI();
                updateView();
            }, (error) => console.error("Error listening to categories:", error));
        }

        function renderCategoryUI() {
            categoryList.innerHTML = '';
            activityCategorySelect.innerHTML = '';
            if (allCategories.size === 0) {
                noCategoryMsg.classList.remove('hidden');
                activityCategorySelect.innerHTML = '<option disabled selected>กรุณาเพิ่มประเภทก่อน</option>';
                activityCategorySelect.required = false;
                return;
            }
            noCategoryMsg.classList.add('hidden');
            activityCategorySelect.innerHTML = '<option value="" disabled selected>เลือกประเภทกิจกรรม</option>';
            activityCategorySelect.required = true;
            allCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id; option.textContent = cat.name;
                activityCategorySelect.appendChild(option);
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-2 rounded-md hover:bg-gray-50 transition-colors'; 
                item.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="block w-4 h-4 rounded-full" style="background-color: ${cat.color};"></span>
                        <span class="text-sm font-medium text-gray-800">${cat.name}</span>
                    </div>
                    <button class="delete-category-btn text-red-400 hover:text-red-600 p-1" data-id="${cat.id}">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6zm2 2v6h2V8H9z" clip-rule="evenodd"></path></svg>
                    </button>
                `;
                categoryList.appendChild(item);
            });
        }
        
        function listenForActivities() {
            if (!isReady) return;
            const q = query(activitiesCollectionRef);
            onSnapshot(q, (snapshot) => {
                allActivities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateView();
            }, (error) => console.error("Error listening to activities:", error));
        }
        
        function updateActivityDots() {
            if (allCategories.size === 0) return;
            const dotsMap = new Map();
            for (const act of allActivities) {
                const category = allCategories.get(act.categoryId);
                if (!category) continue;
                const color = category.color;
                if (!dotsMap.has(act.date)) dotsMap.set(act.date, new Set());
                dotsMap.get(act.date).add(color);
            }
            document.querySelectorAll('.day-cell').forEach(cell => {
                const dotContainer = cell.querySelector('.dot-container');
                if (!dotContainer) return;
                dotContainer.innerHTML = '';
                const date = cell.dataset.date;
                const colors = dotsMap.get(date);
                if (colors) {
                    let dotCount = 0;
                    colors.forEach(color => {
                        if (dotCount < 6) {
                            const dotEl = document.createElement('span');
                            dotEl.className = 'dot';
                            dotEl.style.backgroundColor = color;
                            dotContainer.appendChild(dotEl);
                            dotCount++;
                        }
                    });
                }
            });
        }

        async function handleAddActivity(e) {
            e.preventDefault();
            const date = activityDateInput.value, categoryId = activityCategorySelect.value, description = activityDescInput.value.trim();
            if (!isReady || !date || !categoryId || !description) return;
            const newActivity = { date, categoryId, description, createdAt: new Date().toISOString() };
            try {
                await addDoc(activitiesCollectionRef, newActivity);
                activityDescInput.value = '';
            } catch (error) { console.error("Error adding activity: ", error); }
        }
        
        async function handleAddCategory(e) {
            e.preventDefault();
            const name = categoryNameInput.value.trim(), color = categoryColorInput.value;
            if (!isReady || !name) return;
            const newCategory = { name, color, createdAt: new Date().toISOString() };
            try {
                await addDoc(categoriesCollectionRef, newCategory);
                categoryNameInput.value = ''; categoryColorInput.value = '#3b82f6';
            } catch (error) { console.error("Error adding category: ", error); }
        }

        async function handleDeleteActivity(docId) {
            if (!isReady || !window.confirm("ลบกิจกรรมนี้?")) return;
            try {
                await deleteDoc(doc(db, activitiesCollectionRef.path, docId));
            } catch (error) { console.error("Error deleting activity: ", error); }
        }
        
        async function handleDeleteCategory(docId) {
            if (!isReady || !window.confirm("การลบประเภทจะทำให้กิจกรรมที่เกี่ยวข้องไม่แสดงชื่อประเภท ยืนยันหรือไม่?")) return;
            try {
                await deleteDoc(doc(db, categoriesCollectionRef.path, docId));
            } catch (error) { console.error("Error deleting category: ", error); }
        }

        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</body>
</html>
