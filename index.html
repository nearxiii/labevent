<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏î‡πâ‡∏ß‡∏¢ Firebase</title>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô Inter */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 600px; }
    </style>
</head>
<body>
    <div id="app" class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ üìù
        </h1>
        
        <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞ User ID -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <p id="loading-status" class="text-indigo-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            <p id="user-id-display" class="text-sm text-gray-500 mt-2 break-all hidden">
                ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (UserId): <span class="font-mono text-gray-700"></span>
            </p>
        </div>

        <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà -->
        <div id="todo-form-container" class="bg-white p-6 rounded-xl shadow-lg mb-8 hidden">
            <div class="flex space-x-3">
                <input type="text" id="new-todo-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                       maxlength="100">
                <button id="add-todo-button"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-5 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg">
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°
                </button>
            </div>
        </div>

        <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <ul id="todo-list" class="space-y-3">
                <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÇ‡∏î‡∏¢ JavaScript -->
            </ul>
        </div>
        
        <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) -->
        <div id="error-message" class="text-red-600 font-semibold mt-4 text-center hidden"></div>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô Script ‡∏Ç‡∏≠‡∏á Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡∏ö‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firestore
        setLogLevel('debug');

        // --- 1. CONFIGURATION AND ENVIRONMENT CHECK ---

        const CANVAS_APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-canvas-app-id';
        const CANVAS_FIREBASE_CONFIG = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const CANVAS_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // ** CONFIG ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Deploy ‡∏ô‡∏≠‡∏Å Canvas Environment (‡πÄ‡∏ä‡πà‡∏ô Vercel) **
        // *** ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á Deploy ‡∏ö‡∏ô Vercel ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤ 'YOUR_...' ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
        const VERCEL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBxgoNJobE20jv6HrfGhVxMzS85ARsudg0", 
            authDomain: "labevent-49643.firebaseapp.com",
            projectId: "labevent-49643", 
            storageBucket: "labevent-49643.firebasestorage.app",
            messagingSenderId: "894959859014",
            appId: "1:894959859014:web:b46866f5f9fbc2aa302147", // Example Web App ID
        };
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Canvas Environment ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÇ‡∏î‡∏¢‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏µ config ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà {} ‡πÑ‡∏´‡∏°)
        const isCanvasEnvironment = Object.keys(CANVAS_FIREBASE_CONFIG).length > 0 && CANVAS_FIREBASE_CONFIG.projectId;
        
        const appId = isCanvasEnvironment ? CANVAS_APP_ID : CANVAS_APP_ID + '-vercel-prod';
        const firebaseConfig = isCanvasEnvironment ? CANVAS_FIREBASE_CONFIG : VERCEL_FIREBASE_CONFIG;
        const initialAuthToken = CANVAS_AUTH_TOKEN; 

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Config ‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô Placeholder ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const isPlaceholderConfig = !isCanvasEnvironment && 
                                    (firebaseConfig.apiKey === "AIzaSyBxgoNJobE20jv6HrfGhVxMzS85ARsudg0" || 
                                     firebaseConfig.projectId === "labevent-49643");
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firebase Services
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let isDemoMode = false;

        // Elements
        const loadingStatusEl = document.getElementById('loading-status');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const userIdSpanEl = userIdDisplayEl.querySelector('span');
        const todoFormContainerEl = document.getElementById('todo-form-container');
        const newTodoInputEl = document.getElementById('new-todo-input');
        const addTodoButtonEl = document.getElementById('add-todo-button');
        const todoListEl = document.getElementById('todo-list');
        const errorEl = document.getElementById('error-message');

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
         * @param {string} message ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
         */
        function displayError(message) {
            console.error(message);
            errorEl.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${message}`;
            errorEl.classList.remove('hidden');
            loadingStatusEl.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î';
            loadingStatusEl.classList.add('text-red-600');
            loadingStatusEl.classList.remove('text-indigo-600');
        }

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
         */
        async function initializeFirebase() {
            try {
                if (isPlaceholderConfig) {
                    isDemoMode = true;
                    userId = `DEMO_USER_${Math.random().toString(36).substring(2, 6).toUpperCase()}`;
                    isAuthReady = true;
                    loadingStatusEl.textContent = '‚ö†Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≤‡∏ò‡∏¥‡∏ï: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Vercel Config';
                    loadingStatusEl.classList.remove('text-indigo-600');
                    loadingStatusEl.classList.add('text-orange-600');
                    userIdSpanEl.textContent = userId;
                    userIdDisplayEl.classList.remove('hidden');
                    todoFormContainerEl.classList.remove('hidden');
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Demo Mode ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏±‡∏ö Firestore
                    todoListEl.innerHTML = '<li class="text-center text-orange-500">‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≤‡∏ò‡∏¥‡∏ï. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å.</li>';
                    return;
                }
                
                // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
                let signInSuccessful = false;
                if (initialAuthToken) {
                    try {
                        // ‡πÉ‡∏ä‡πâ custom token ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏°‡∏≤
                        await signInWithCustomToken(auth, initialAuthToken);
                        signInSuccessful = true;
                        loadingStatusEl.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Custom Token)';
                    } catch (tokenError) {
                        console.warn("‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Custom Token ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß, ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ Anonymously:", tokenError);
                    }
                }
                
                // ‡∏´‡∏≤‡∏Å Custom Token ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ‡πÉ‡∏´‡πâ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
                if (!signInSuccessful) {
                    await signInAnonymously(auth);
                    loadingStatusEl.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô)';
                }

                // 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdSpanEl.textContent = userId;
                        userIdDisplayEl.classList.remove('hidden');
                        todoFormContainerEl.classList.remove('hidden');
                        isAuthReady = true;
                        
                        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥
                        loadTodos();
                    } else {
                        userId = null;
                        isAuthReady = true;
                        loadingStatusEl.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ';
                        todoListEl.innerHTML = '<li class="text-center text-gray-500">‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</li>';
                    }
                });

            } catch (error) {
                displayError(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ${error.message}`);
            }
        }

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Collection Path ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
         * ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ: /artifacts/{appId}/users/{userId}/todos
         */
        function getTodosCollectionRef() {
            if (!db || !userId) {
                throw new Error("Firebase ‡∏´‡∏£‡∏∑‡∏≠ User ID ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°");
            }
            // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Private Path)
            const collectionPath = `artifacts/${appId}/users/${userId}/todos`;
            return collection(db, collectionPath);
        }

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà
         */
        async function saveTodo() {
            const text = newTodoInputEl.value.trim();
            if (!text || !isAuthReady || !userId || isDemoMode) return; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç isDemoMode

            addTodoButtonEl.disabled = true;
            addTodoButtonEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            try {
                await addDoc(getTodosCollectionRef(), {
                    text: text,
                    completed: false,
                    createdAt: Date.now()
                });
                newTodoInputEl.value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            } catch (error) {
                displayError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${error.message}`);
            } finally {
                addTodoButtonEl.disabled = false;
                addTodoButtonEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°';
            }
        }

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ (‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå/‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à)
         */
        async function toggleTodo(todoId, currentStatus) {
            if (!isAuthReady || !userId || isDemoMode) return; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç isDemoMode

            try {
                const todoDocRef = doc(getTodosCollectionRef(), todoId);
                await updateDoc(todoDocRef, {
                    completed: !currentStatus
                });
            } catch (error) {
                displayError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${error.message}`);
            }
        }

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥
         */
        async function deleteTodo(todoId) {
            if (!isAuthReady || !userId || isDemoMode) return; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç isDemoMode

            try {
                const todoDocRef = doc(getTodosCollectionRef(), todoId);
                await deleteDoc(todoDocRef);
            } catch (error) {
                displayError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${error.message}`);
            }
        }

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
         */
        function loadTodos() {
            if (!isAuthReady || !userId || isDemoMode) return; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç isDemoMode
            
            try {
                const todosQuery = query(getTodosCollectionRef());

                // ‡πÉ‡∏ä‡πâ onSnapshot ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
                onSnapshot(todosQuery, (snapshot) => {
                    loadingStatusEl.textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                    loadingStatusEl.classList.remove('text-indigo-600', 'text-red-600');
                    
                    todoListEl.innerHTML = '';
                    if (snapshot.empty) {
                        todoListEl.innerHTML = '<li class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥! ‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</li>';
                        return;
                    }

                    const sortedTodos = [];
                    snapshot.forEach(doc => {
                        sortedTodos.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô client (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ orderBy ‡πÉ‡∏ô query ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ index)
                    sortedTodos.sort((a, b) => a.createdAt - b.createdAt);

                    sortedTodos.forEach(todo => {
                        const li = document.createElement('li');
                        li.className = `flex items-center p-3 rounded-lg transition duration-150 ${todo.completed ? 'bg-green-50' : 'bg-gray-50'} shadow-sm`;
                        li.innerHTML = `
                            <input type="checkbox" id="todo-${todo.id}" ${todo.completed ? 'checked' : ''} 
                                   class="form-checkbox h-5 w-5 text-indigo-600 rounded cursor-pointer">
                            <label for="todo-${todo.id}" class="ml-4 flex-grow text-gray-800 ${todo.completed ? 'line-through text-gray-500' : ''} break-words">
                                ${todo.text}
                            </label>
                            <button class="delete-btn text-red-500 hover:text-red-700 ml-4 p-1 rounded-full hover:bg-red-100 transition duration-150" 
                                    data-id="${todo.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 100 2v6a1 1 0 100-2V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        `;
                        
                        // ‡∏ú‡∏π‡∏Å Event Listeners
                        li.querySelector('input[type="checkbox"]').addEventListener('change', () => {
                            toggleTodo(todo.id, todo.completed);
                        });
                        li.querySelector('.delete-btn').addEventListener('click', () => {
                            deleteTodo(todo.id);
                        });

                        todoListEl.appendChild(li);
                    });
                }, (error) => {
                    displayError(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`);
                });

            } catch (error) {
                displayError(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`);
            }
        }

        // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
        initializeFirebase();

        // 2. ‡∏ú‡∏π‡∏Å Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°
        addTodoButtonEl.addEventListener('click', saveTodo);
        newTodoInputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                saveTodo();
            }
        });

    </script>
</body>
</html>
